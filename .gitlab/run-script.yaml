stages:
  - run-script

run-script:
  stage: run-script
  image: mcr.microsoft.com/powershell
  variables:
    WORKING_DIRECTORY: $CI_PROJECT_DIR
    RUN_TERRAFORM_INIT: "true"
    RUN_TERRAFORM_PLAN: "true"
    RUN_TERRAFORM_PLAN_DESTROY: "false"
    RUN_TERRAFORM_APPLY: "false"
    RUN_TERRAFORM_DESTROY: "false"
    ENABLE_DEBUG_MODE: "true"
    DELETE_PLAN_FILES: "true"
    TERRAFORM_VERSION: "latest"
    TERRAFORM_STATE_NAME: "cscot-dev.terraform.tfstate"
  script:
    - pwsh -Command ".\Run-Terraform.ps1 -WorkingDirectory ${WORKING_DIRECTORY} -RunTerraformInit ${RUN_TERRAFORM_INIT} -RunTerrformPlan ${RUN_TERRAFORM_PLAN} -RunTerraformPlanDestroy ${RUN_TERRAFORM_PLAN_DESTROY} -RunTerraformApply ${RUN_TERRAFORM_APPLY} -RunTerraformDestroy ${RUN_TERRAFORM_DESTROY} -DebugMode ${ENABLE_DEBUG_MODE} -DeletePlanFiles ${DELETE_PLAN_FILES} -TerraformVersion ${TERRAFORM_VERSION} -BackendStorageSubscriptionId ${SPOKE_SUB_ID} -BackendStorageResourceGroupName ${SPOKE_SA_RG_NAME} -BackendStorageAccountName ${SPOKE_SA_NAME} -BackendStorageAccountBlobContainerName ${SPOKE_SA_BLOB_CONTAINER_NAME} -TerraformStateName ${TERRAFORM_STATE_NAME}"
  only:
    - triggers
    - web
